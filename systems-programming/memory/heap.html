<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8"/>
    <link rel="icon" href="../../favicon.svg"/>
    <link rel="stylesheet" href="../../fonts/Inter/inter.css"/>
    <link rel="stylesheet" href="../../fonts/JetBrainsMono/jetbrainsmono.css"/>
    <link rel="stylesheet" href="../../variables.css"/>
    <link rel="stylesheet" href="../../global.css"/>
    <link rel="stylesheet" href="../../katex.css"/>

    <link rel="stylesheet" media="print" href="../../print.css">

    <meta name="viewport" content="width=device-width, initial-scale=1"/>
    
		<link href="../../_app/immutable/assets/Link.Cb7NHG_N.css" rel="stylesheet">
		<link href="../../_app/immutable/assets/Button.DCPIk07g.css" rel="stylesheet">
		<link href="../../_app/immutable/assets/Icon.D0g2C4hd.css" rel="stylesheet">
		<link href="../../_app/immutable/assets/0.ieOoEAmI.css" rel="stylesheet">
		<link href="../../_app/immutable/assets/2.DXAScjb8.css" rel="stylesheet">
		<link href="../../_app/immutable/assets/Title.DPHn_YVg.css" rel="stylesheet">
		<link href="../../_app/immutable/assets/Par.K_845M5t.css" rel="stylesheet">
		<link href="../../_app/immutable/assets/P.BQjmqsBn.css" rel="stylesheet">
		<link href="../../_app/immutable/assets/Math.oZcZgltA.css" rel="stylesheet">
		<link href="../../_app/immutable/assets/InternalCode.18_KRbfN.css" rel="stylesheet">
		<link href="../../_app/immutable/assets/Code.DJ30TqtG.css" rel="stylesheet">
		<link href="../../_app/immutable/assets/Heading.B4n5dO8q.css" rel="stylesheet">
		<link href="../../_app/immutable/assets/EnumList.CtnWplwG.css" rel="stylesheet">
		<link href="../../_app/immutable/assets/ListItem.BKpMqDLa.css" rel="stylesheet">
		<link href="../../_app/immutable/assets/Subheading.Sazqxtg1.css" rel="stylesheet">
		<link href="../../_app/immutable/assets/Codeblock.CTVfIT4f.css" rel="stylesheet">
		<link href="../../_app/immutable/assets/ExerciseList.Czer9ibd.css" rel="stylesheet">
		<link href="../../_app/immutable/assets/Exercise.BsVMV4VF.css" rel="stylesheet">
		<link rel="modulepreload" href="../../_app/immutable/entry/start.Dkklk6Rf.js">
		<link rel="modulepreload" href="../../_app/immutable/chunks/DsAObCLR.js">
		<link rel="modulepreload" href="../../_app/immutable/chunks/O64VAD6H.js">
		<link rel="modulepreload" href="../../_app/immutable/chunks/BWp35gWV.js">
		<link rel="modulepreload" href="../../_app/immutable/chunks/DIeogL5L.js">
		<link rel="modulepreload" href="../../_app/immutable/chunks/CNky9LEp.js">
		<link rel="modulepreload" href="../../_app/immutable/chunks/HEAPfHvV.js">
		<link rel="modulepreload" href="../../_app/immutable/chunks/DkB2Co80.js">
		<link rel="modulepreload" href="../../_app/immutable/entry/app.Bva7xl9u.js">
		<link rel="modulepreload" href="../../_app/immutable/chunks/CWj6FrbW.js">
		<link rel="modulepreload" href="../../_app/immutable/chunks/BOcoFmK4.js">
		<link rel="modulepreload" href="../../_app/immutable/chunks/MBbrtcMh.js">
		<link rel="modulepreload" href="../../_app/immutable/chunks/D-GYhs9T.js">
		<link rel="modulepreload" href="../../_app/immutable/nodes/0.LPgsIMBt.js">
		<link rel="modulepreload" href="../../_app/immutable/chunks/C9z9AdnA.js">
		<link rel="modulepreload" href="../../_app/immutable/chunks/DDpIWRRY.js">
		<link rel="modulepreload" href="../../_app/immutable/chunks/DlH7fH6r.js">
		<link rel="modulepreload" href="../../_app/immutable/chunks/DvKvArtv.js">
		<link rel="modulepreload" href="../../_app/immutable/chunks/DPocoKFO.js">
		<link rel="modulepreload" href="../../_app/immutable/chunks/UpSqMDag.js">
		<link rel="modulepreload" href="../../_app/immutable/chunks/69_IOA4Y.js">
		<link rel="modulepreload" href="../../_app/immutable/nodes/2.Di9RQfus.js">
		<link rel="modulepreload" href="../../_app/immutable/nodes/154.CT9gYHhw.js">
		<link rel="modulepreload" href="../../_app/immutable/chunks/CR7k0xtG.js">
		<link rel="modulepreload" href="../../_app/immutable/chunks/DPzc5wQr.js">
		<link rel="modulepreload" href="../../_app/immutable/chunks/B7flgP-x.js">
		<link rel="modulepreload" href="../../_app/immutable/chunks/BqyEoRxA.js">
		<link rel="modulepreload" href="../../_app/immutable/chunks/DAvg0_9P.js">
		<link rel="modulepreload" href="../../_app/immutable/chunks/C2dv2nOL.js">
		<link rel="modulepreload" href="../../_app/immutable/chunks/BmgYHZay.js">
		<link rel="modulepreload" href="../../_app/immutable/chunks/CpJhWio5.js">
		<link rel="modulepreload" href="../../_app/immutable/chunks/i9XClpbl.js">
		<link rel="modulepreload" href="../../_app/immutable/chunks/DXKx2xvL.js">
		<link rel="modulepreload" href="../../_app/immutable/chunks/BJkbutPt.js">
		<link rel="modulepreload" href="../../_app/immutable/chunks/NE91WFFs.js">
		<link rel="modulepreload" href="../../_app/immutable/chunks/CBbFRhrb.js">
		<link rel="modulepreload" href="../../_app/immutable/chunks/BvAJckrt.js">
		<link rel="modulepreload" href="../../_app/immutable/chunks/CYdjygJj.js">
		<link rel="modulepreload" href="../../_app/immutable/chunks/C5ZJ-BW2.js"><!--[--><!--]--><!--[--><!--]--><title>Куча</title>
</head>
<body data-sveltekit-preload-data="hover">
<div style="display: contents"><!--[--><!--[--><!----><header class="svelte-9v5dz7"><img src="/favicon.svg" alt="" role="presentation" class="svelte-9v5dz7"/> <button type="button" id="mobile-menu-button" class="subtle svelte-apk4jo"><!--[!--><svg viewBox="0 0 48 48" fill="currentColor" xmlns="http://www.w3.org/2000/svg" class="svelte-1tf3wrl" style="height: 1.5rem; margin: 0rem;"><path d="M40 12L8 12" stroke="currentColor" stroke-width="6" stroke-linecap="round"></path><path d="M40 24L8 24" stroke="currentColor" stroke-width="6" stroke-linecap="round"></path><path d="M40 36L8 36" stroke="currentColor" stroke-width="6" stroke-linecap="round"></path><!----></svg><!----> Меню<!----><!--]--></button><!----> <!--[--><nav class="svelte-9v5dz7"><!--[--><a href="/knowledge" class="svelte-1txvory colorless"><!---->База знаний<!----></a><a href="/scenario" class="svelte-1txvory colorless"><!---->Сценарий<!----></a><a href="/tasks" class="svelte-1txvory colorless"><!---->Задания<!----></a><a href="/rules" class="svelte-1txvory colorless"><!---->Правила игры<!----></a><!--]--></nav><!--]--></header> <!--[!--><!--]--><!----><!----> <main><!--[--><!----><article class="svelte-1cvbhgs"><!----><div class="title svelte-uw1xhm"><!--[!--><h1 class="svelte-uw1xhm">Куча</h1><!--]--></div><!----> <h1 class="svelte-mdj34r"><!---->Аллокаторы<!----></h1><!----> <div class="par svelte-q2zea3"><p class="svelte-xyzgp3"><!---->Куча структурно представляет собой много блоков памяти, которые или заняты, или свободны.<!----></p><!----> <p class="svelte-xyzgp3"><!---->картинка<!----></p><!----><!----></div><!----> <div class="par svelte-q2zea3"><p class="svelte-xyzgp3"><!---->Самих реализаций аллокаторов много, все отличаются друг от друга структурой хранения блоков,
    стратегией и алгоритмом поиска блоков и самой организации блоков.<!----></p><!----> <p class="svelte-xyzgp3"><!---->Если максимально обобщать, работа аллокаторов сводится к выполнению двух операций —
    выделения блока памяти <span class="code svelte-1kfz46x"><code class="language-pseudocode svelte-127l4oe"><!---->malloc<!----></code><!----></span><!----> и освобождения блока памяти <span class="code svelte-1kfz46x"><code class="language-pseudocode svelte-127l4oe"><!----><span class="keyword">free</span><!----></code><!----></span><!---->.<!----></p><!----><!----></div><!----> <div class="par svelte-q2zea3"><p class="svelte-xyzgp3"><!---->Во время вызова <span class="code svelte-1kfz46x"><code class="language-pseudocode svelte-127l4oe"><!---->malloc<!----></code><!----></span><!----> происходит примерно следующее:<!----></p><!----></div><!----> <ol class="svelte-73zp5l wide"><li class="svelte-fa1o"><p class="svelte-xyzgp3"><!---->Среди свободных блоков ищется блок подходящего размера.<!----></p><!----> <p class="svelte-xyzgp3"><!---->Используются разные стратегии: может выбираться как первый подходящий (first-fit), как самый маленький
    среди подходящих (best-fit), так и самый большой среди подходящих (worst-fit).<!----></p><!----> <p class="svelte-xyzgp3"><!---->Если блок найден не был, то куча расширяется и появляются новые свободные блоки.<!----></p><!----><!----></li><!----> <li class="svelte-fa1o"><p class="svelte-xyzgp3"><!---->Если найденный блок не совпадает по размеру с запрашиваемым, он делится на два.
    Например, если был запрошен блок в <!--[!--><span class="math"><!----><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>20</mn></mrow><annotation encoding="application/x-tex">20</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">20</span></span></span></span><!----></span><!--]--><!----> байт, а аллокатор нашёл блок в <!--[!--><span class="math"><!----><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>32</mn></mrow><annotation encoding="application/x-tex">32</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">32</span></span></span></span><!----></span><!--]--><!----> байта,
    аллокатор поделит найденный блок на два блока —
    один в <!--[!--><span class="math"><!----><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>20</mn></mrow><annotation encoding="application/x-tex">20</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">20</span></span></span></span><!----></span><!--]--><!----> байт и второй в <!--[!--><span class="math"><!----><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>12</mn></mrow><annotation encoding="application/x-tex">12</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">12</span></span></span></span><!----></span><!--]--><!----> байт.<!----></p><!----></li><!----> <li class="svelte-fa1o"><p class="svelte-xyzgp3"><!---->Выбранный блок помечается занятым и передаётся программе.<!----></p><!----></li><!----><!----></ol><!----> <div class="par svelte-q2zea3"><p class="svelte-xyzgp3"><!---->Во время вызова <span class="code svelte-1kfz46x"><code class="language-pseudocode svelte-127l4oe"><!----><span class="keyword">free</span><!----></code><!----></span><!----> происходит примерно следующее:<!----></p><!----></div><!----> <ol class="svelte-73zp5l wide"><li class="svelte-fa1o"><p class="svelte-xyzgp3"><!---->Выбранный блок помечается свободным<!----></p><!----></li><!----> <li class="svelte-fa1o"><p class="svelte-xyzgp3"><!---->Свободный блок объединяется с соседними свободными блоками в один большой свободный блок.<!----></p><!----></li><!----><!----></ol><!----> <h1 class="svelte-1trpu2y"><!---->Классический first-fit<!----></h1><!----> <div class="par svelte-q2zea3"><p class="svelte-xyzgp3"><!---->Этот алгоритм был первым алгоритмом раздачи памяти в C.
    Появился он ещё в 1970-х годах в самых первых версиях Unix и C, разработанных в Bell Labs.
    При этом держался такой алгоритм долго,
    даже в 1985 году Давид Корн на конференции USENIX говорит об этом алгоритме как о всё ещё распространённом.<!----></p><!----> <p class="svelte-xyzgp3"><!---->Аллокатор был реализован как кольцевой односвязный список.
    В списке хранились блоки памяти с заголовком — указателем на следующий блок <span class="code svelte-1kfz46x"><code class="language-pseudocode svelte-127l4oe"><!---->next<!----></code><!----></span><!---->.
    В те времена размер указателя был всего <!--[!--><span class="math"><!----><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>2</mn></mrow><annotation encoding="application/x-tex">2</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">2</span></span></span></span><!----></span><!--]--><!----> байта.
    Длина блока вычислялась неявно по формуле<!----></p><!----> <!--[--><div class="math-display svelte-16qk674"><!----><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mtext>размер данных текущего блока</mtext><mo>=</mo><mtext>адрес следующего блока next</mtext><mo>−</mo><mtext>адрес текущего блока</mtext><mo>−</mo><mtext>длина заголовка</mtext></mrow><annotation encoding="application/x-tex">\text{размер данных текущего блока} = \text{адрес следующего блока}~\code{next} - \text{адрес текущего блока} - \text{длина заголовка}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em;"></span><span class="mord text"><span class="mord cyrillic_fallback">размер</span><span class="mord"> </span><span class="mord cyrillic_fallback">данных</span><span class="mord"> </span><span class="mord cyrillic_fallback">текущего</span><span class="mord"> </span><span class="mord cyrillic_fallback">блока</span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em;"></span><span class="mord text"><span class="mord cyrillic_fallback">адрес</span><span class="mord"> </span><span class="mord cyrillic_fallback">следующего</span><span class="mord"> </span><span class="mord cyrillic_fallback">блока</span></span><span class="mspace nobreak"> </span><span class="enclosing code"><span class="mord text"><span class="mord">next</span></span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em;"></span><span class="mord text"><span class="mord cyrillic_fallback">адрес</span><span class="mord"> </span><span class="mord cyrillic_fallback">текущего</span><span class="mord"> </span><span class="mord cyrillic_fallback">блока</span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.1944em;"></span><span class="mord text"><span class="mord cyrillic_fallback">длина</span><span class="mord"> </span><span class="mord cyrillic_fallback">заголовка</span></span></span></span></span></span><!----></div><!--]--><!----> <p class="svelte-xyzgp3"><!---->Блоки были выровнены по <!--[!--><span class="math"><!----><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>2</mn></mrow><annotation encoding="application/x-tex">2</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">2</span></span></span></span><!----></span><!--]--><!----> байтам, поэтому младший бит <span class="code svelte-1kfz46x"><code class="language-pseudocode svelte-127l4oe"><!---->next<!----></code><!----></span><!----> был всегда <!--[!--><span class="math"><!----><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>0</mn></mrow><annotation encoding="application/x-tex">0</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">0</span></span></span></span><!----></span><!--]--><!---->.
    Его использовали как флаг занятости блока: <!--[!--><span class="math"><!----><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>0</mn></mrow><annotation encoding="application/x-tex">0</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">0</span></span></span></span><!----></span><!--]--><!----> — блок свободен, <!--[!--><span class="math"><!----><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>1</mn></mrow><annotation encoding="application/x-tex">1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">1</span></span></span></span><!----></span><!--]--><!----> — блок
    занят.<!----></p><!----> <p class="svelte-xyzgp3"><!---->Когда <span class="code svelte-1kfz46x"><code class="language-pseudocode svelte-127l4oe"><!---->malloc<!----></code><!----></span><!----> находил адрес свободного блока,
    он сдвигал его на длину заголовка и возвращал сдвинутый адрес, пряча тем самым заголовок.<!----></p><!----><!----></div><!----> <div class="par svelte-q2zea3"><p class="svelte-xyzgp3"><!---->Поиск свободного пространства ускорялся за счёт введения блуждающего указателя <span class="code svelte-1kfz46x"><code class="language-pseudocode svelte-127l4oe"><!---->roving_ptr<!----></code><!----></span><!---->.
    Этот указатель запоминал позицию, где аллокатор закончил работу в прошлый раз.
    Это ускоряло последующие поиски, так как поиск начинался
    не с начала списка каждый раз, а с места последней операции.<!----></p><!----> <p class="svelte-xyzgp3"><!---->Объединение во время выполнения операции <span class="code svelte-1kfz46x"><code class="language-pseudocode svelte-127l4oe"><!----><span class="keyword">free</span><!----></code><!----></span><!----> не происходит.
    Там просто освобождаемый блок помечается свободным.
    Объединение будет произведено во время следующего обхода списка при выполнении операции <span class="code svelte-1kfz46x"><code class="language-pseudocode svelte-127l4oe"><!---->malloc<!----></code><!----></span><!---->.<!----></p><!----><!----></div><!----> <div class="par svelte-q2zea3"><p class="svelte-xyzgp3"><!---->Накладные расходы на память у такого аллокатора минимальны.
    Но есть две проблемы: невысокая производительность и внешняя фрагментация.
    Быстро накапливаются мелкие свободные блоки, при этом при
    большом количестве свободной памяти какой-нибудь большой кусок выделить невозможно — просто нет такой
    непрерывной свободной области. Да и слияние блоков во время <span class="code svelte-1kfz46x"><code class="language-pseudocode svelte-127l4oe"><!---->malloc<!----></code><!----></span><!----> неэффективно.<!----></p><!----></div><!----> <h1 class="svelte-1trpu2y"><!---->Алгоритм двойных меток<!----></h1><!----> <div class="par svelte-q2zea3"><p class="svelte-xyzgp3"><!---->Алгоритм двойных меток был разработан Дональдом Кнутом в 1962 году при работе над Burroughs 5000.<!----></p><!----> <p class="svelte-xyzgp3"><!---->Структура аллокатора такая же, как и у первого алгоритма first-fit.
    По краям блоков находятся метки, хранящие информацию об обоих смежных блоках, а именно их длины и занятость.<!----></p><!----><!----></div><!----> <h1 class="svelte-mdj34r"><!---->Системные вызовы<!----></h1><!----> <div class="par svelte-q2zea3"><p class="svelte-xyzgp3"><span class="code svelte-1kfz46x"><code class="language-pseudocode svelte-127l4oe"><!---->mmap<!----></code><!----></span><!----> (memory map) — системный вызов в Unix-подобных системах,
    который отображает файлы или устройства в память процесса.
    Его также используют для анонимного выделения памяти, без привязки к файлу.<!----></p><!----></div><!----> <div class="codeblock svelte-in28rj"><div class="overflow-box svelte-in28rj"><code class="language-c svelte-127l4oe"><!----><span class="builtin">void</span><span class="operator">*</span> <span class="function">mmap</span><span class="punctuation">(</span><span class="builtin">void</span><span class="operator">*</span> addr<span class="punctuation">,</span> <span class="class-name">size_t</span> length<span class="punctuation">,</span> <span class="builtin">int</span> prot<span class="punctuation">,</span> <span class="builtin">int</span> flags<span class="punctuation">,</span>
           <span class="builtin">int</span> fd<span class="punctuation">,</span> <span class="class-name">off_t</span> offset<span class="punctuation">)</span><span class="punctuation">;</span><!----></code><!----></div></div><!----> <div class="par svelte-q2zea3"><p class="svelte-xyzgp3"><span class="code svelte-1kfz46x"><code class="language-c svelte-127l4oe"><!----><span class="builtin">void</span><span class="operator">*</span> addr<!----></code><!----></span><!----> — желаемый адрес для размещения.
    Если <span class="code svelte-1kfz46x"><code class="language-c svelte-127l4oe"><!----><span class="constant">NULL</span><!----></code><!----></span><!---->, то ядро выберет адрес само.
    Если не пусто, будет попытка разместить блок памяти по указанному адресу.<!----></p><!----> <p class="svelte-xyzgp3"><span class="code svelte-1kfz46x"><code class="language-c svelte-127l4oe"><!----><span class="class-name">size_t</span> length<!----></code><!----></span><!----> — размер выделяемой области памяти.
    Округляется вверх до кратного размеру страницы.<!----></p><!----> <p class="svelte-xyzgp3"><span class="code svelte-1kfz46x"><code class="language-c svelte-127l4oe"><!----><span class="builtin">int</span> prot<!----></code><!----></span><!----> — флаги защиты памяти (protection flags).
    Определяет права доступа к выделенной памяти, а точнее к странице памяти.
    Можно комбинировать через <span class="code svelte-1kfz46x"><code class="language-pseudocode svelte-127l4oe"><!----><span class="operator">|</span><!----></code><!----></span><!---->.<br/> <span class="code svelte-1kfz46x"><code class="language-c svelte-127l4oe"><!---->PROT_READ<!----></code><!----></span><!----> — чтение, можно читать из памяти;<br/> <span class="code svelte-1kfz46x"><code class="language-c svelte-127l4oe"><!---->PROT_WRITE<!----></code><!----></span><!----> — запись, можно записывать в память;<br/> <span class="code svelte-1kfz46x"><code class="language-c svelte-127l4oe"><!---->PROT_EXEC<!----></code><!----></span><!----> — исполнение, можно исполнять как код;<br/> <span class="code svelte-1kfz46x"><code class="language-c svelte-127l4oe"><!---->PROT_NONE<!----></code><!----></span><!----> — нет доступа, память полностью недоступна.<!----></p><!----> <p class="svelte-xyzgp3"><span class="code svelte-1kfz46x"><code class="language-c svelte-127l4oe"><!----><span class="builtin">int</span> flags<!----></code><!----></span><!----> — тип и свойства памяти.
    Определяет поведение выделенной памяти, а точнее страниц памяти.
    Можно комбинировать через <span class="code svelte-1kfz46x"><code class="language-pseudocode svelte-127l4oe"><!----><span class="operator">|</span><!----></code><!----></span><!---->.<br/> <span class="code svelte-1kfz46x"><code class="language-c svelte-127l4oe"><!---->MAP_SHARED<!----></code><!----></span><!----> — общее отображение, изменения видны другим процессам и записываются в файл;<br/> <span class="code svelte-1kfz46x"><code class="language-c svelte-127l4oe"><!---->MAP_PRIVATE<!----></code><!----></span><!----> — приватное отображение, изменения не видны другим, используется Copy-on-Write;<br/> <span class="code svelte-1kfz46x"><code class="language-c svelte-127l4oe"><!---->MAP_ANONYMOUS<!----></code><!----></span><!----> — анонимное отображение, не связанное с файлом, применяется для кучи;<br/> <span class="code svelte-1kfz46x"><code class="language-c svelte-127l4oe"><!---->MAP_FIXED<!----></code><!----></span><!----> — точное расположение, требуется разместить точно по <span class="code svelte-1kfz46x"><code class="language-pseudocode svelte-127l4oe"><!---->addr<!----></code><!----></span><!---->, даже если придётся перекрыть какое-то существующее отображение;<br/> <span class="code svelte-1kfz46x"><code class="language-c svelte-127l4oe"><!---->MAP_FIXED_NOREPLACE<!----></code><!----></span><!----> — как и точное расположение, но перекрытие существующих отображений невозможно;<br/> <span class="code svelte-1kfz46x"><code class="language-c svelte-127l4oe"><!---->MAP_POPULATE<!----></code><!----></span><!----> — сразу выделить физические страницы;<br/> <span class="code svelte-1kfz46x"><code class="language-c svelte-127l4oe"><!---->MAP_LOCKED<!----></code><!----></span><!----> — заблокировать, страницы не могут быть вытеснены в swap;<br/> <span class="code svelte-1kfz46x"><code class="language-c svelte-127l4oe"><!---->MAP_HUGETLB<!----></code><!----></span><!----> — использовать большие страницы.<br/><!----></p><!----> <p class="svelte-xyzgp3"><span class="code svelte-1kfz46x"><code class="language-c svelte-127l4oe"><!----><span class="builtin">int</span> fd<!----></code><!----></span><!----> — файловый дескриптор для отображения в память.
    Для анонимного отображения должно быть <span class="code svelte-1kfz46x"><code class="language-pseudocode svelte-127l4oe"><!----><span class="operator">-</span><span class="number">1</span><!----></code><!----></span><!---->.<!----></p><!----> <p class="svelte-xyzgp3"><span class="code svelte-1kfz46x"><code class="language-c svelte-127l4oe"><!----><span class="class-name">off_t</span> offset<!----></code><!----></span><!----> — смещение в файле, с которого нужно начинать отображение.
    Для анонимного отображения должно быть <span class="code svelte-1kfz46x"><code class="language-pseudocode svelte-127l4oe"><!----><span class="number">0</span><!----></code><!----></span><!---->.<!----></p><!----><!----></div><!----> <div class="codeblock svelte-in28rj"><div class="overflow-box svelte-in28rj"><code class="language-c svelte-127l4oe"><!----><span class="builtin">void</span><span class="operator">*</span> ptr <span class="operator">=</span> <span class="function">mmap</span><span class="punctuation">(</span><span class="constant">NULL</span><span class="punctuation">,</span> size<span class="punctuation">,</span> PROT_READ <span class="operator">|</span> PROT_WRITE<span class="punctuation">,</span> MAP_PRIVATE <span class="operator">|</span> MAP_ANONYMOUS<span class="punctuation">,</span> <span class="operator">-</span><span class="number">1</span><span class="punctuation">,</span> <span class="number">0</span><span class="punctuation">)</span><span class="punctuation">;</span>

<span class="keyword">if</span> <span class="punctuation">(</span>ptr <span class="operator">==</span> MAP_FAILED<span class="punctuation">)</span> <span class="punctuation">{</span>
    <span class="function">perror</span><span class="punctuation">(</span><span class="string">&quot;mmap failed&quot;</span><span class="punctuation">)</span><span class="punctuation">;</span>
    <span class="keyword">return</span> <span class="number">1</span><span class="punctuation">;</span>
<span class="punctuation">}</span>

<span class="function">printf</span><span class="punctuation">(</span><span class="string">&quot;Выделено: %p\n\n&quot;</span><span class="punctuation">,</span> ptr<span class="punctuation">)</span><span class="punctuation">;</span>

<span class="function">strcpy</span><span class="punctuation">(</span><span class="punctuation">(</span><span class="builtin">char</span><span class="operator">*</span><span class="punctuation">)</span>ptr<span class="punctuation">,</span> <span class="string">&quot;Hello from mmap!&quot;</span><span class="punctuation">)</span><span class="punctuation">;</span>
<span class="function">printf</span><span class="punctuation">(</span><span class="string">&quot;Прочитали: %s\n\n&quot;</span><span class="punctuation">,</span> <span class="punctuation">(</span><span class="builtin">char</span><span class="operator">*</span><span class="punctuation">)</span>ptr<span class="punctuation">)</span><span class="punctuation">;</span>

<span class="keyword">for</span> <span class="punctuation">(</span><span class="class-name">size_t</span> i <span class="operator">=</span> <span class="number">0</span><span class="punctuation">;</span> i <span class="operator">&lt;</span> size <span class="operator">-</span> <span class="number">1</span><span class="punctuation">;</span> i<span class="operator">++</span><span class="punctuation">)</span> <span class="punctuation">{</span>
    <span class="punctuation">(</span><span class="punctuation">(</span><span class="builtin">char</span><span class="operator">*</span><span class="punctuation">)</span>ptr<span class="punctuation">)</span><span class="punctuation">[</span>i<span class="punctuation">]</span> <span class="operator">=</span> <span class="char">&apos;A&apos;</span> <span class="operator">+</span> <span class="punctuation">(</span>i <span class="operator">%</span> <span class="number">26</span><span class="punctuation">)</span><span class="punctuation">;</span>
<span class="punctuation">}</span>
<span class="punctuation">(</span><span class="punctuation">(</span><span class="builtin">char</span><span class="operator">*</span><span class="punctuation">)</span>ptr<span class="punctuation">)</span><span class="punctuation">[</span>size <span class="operator">-</span> <span class="number">1</span><span class="punctuation">]</span> <span class="operator">=</span> <span class="char">&apos;\0&apos;</span><span class="punctuation">;</span><!----></code><!----></div></div><!----> <h1 class="svelte-mdj34r"><!---->Упражнения<!----></h1><!----> <ol class="svelte-hrmbq3"><div class="exercise svelte-k0j6qq" id="exercise-1"><div class="head svelte-k0j6qq"><div class="number svelte-k0j6qq">1</div> <div class="mark svelte-k0j6qq"><!--[!--><!--]--></div></div> <div class="exercise-body svelte-k0j6qq"><p class="svelte-xyzgp3"><!---->Придумайте последовательность вызовов <span class="code svelte-1kfz46x"><code class="language-pseudocode svelte-127l4oe"><!---->malloc<!----></code><!----></span><!----> и <span class="code svelte-1kfz46x"><code class="language-pseudocode svelte-127l4oe"><!----><span class="keyword">free</span><!----></code><!----></span><!---->, которая заставит
    классический алгоритм first-fit работать за время <!--[!--><span class="math"><!----><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>O</mi><mo stretchy="false">(</mo><mi>n</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">O(n)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.02778em;">O</span><span class="mopen">(</span><span class="mord mathnormal">n</span><span class="mclose">)</span></span></span></span><!----></span><!--]--><!----> на каждый вызов <span class="code svelte-1kfz46x"><code class="language-pseudocode svelte-127l4oe"><!---->malloc<!----></code><!----></span><!---->.
    Объясните, как блуждающий указатель смягчает эту проблему, но не решает её полностью.<!----></p><!----></div></div><!----> <div class="exercise svelte-k0j6qq" id="exercise-2"><div class="head svelte-k0j6qq"><div class="number svelte-k0j6qq">2</div> <div class="mark svelte-k0j6qq"><!--[!--><!--]--></div></div> <div class="exercise-body svelte-k0j6qq"><p class="svelte-xyzgp3"><!---->Напишите классический first-fit аллокатор. Подумайте над его оптимизацией.
    Можно разделить общий список блоков на несколько списков по размеру блоков:
    в одном списке будут только очень маленькие блоки, в другом побольше, и так далее.<!----></p><!----></div></div><!----><!----></ol><!----><!----><!----></article> <div class="svelte-1cvbhgs"></div><!----><!--]--><!----></main><!----><!--]--> <!--[!--><!--]--><!--]-->
			
			<script>
				{
					__sveltekit_1h7j5ru = {
						base: new URL("../..", location).pathname.slice(0, -1)
					};

					const element = document.currentScript.parentElement;

					Promise.all([
						import("../../_app/immutable/entry/start.Dkklk6Rf.js"),
						import("../../_app/immutable/entry/app.Bva7xl9u.js")
					]).then(([kit, app]) => {
						kit.start(app, element, {
							node_ids: [0, 2, 154],
							data: [null,null,null],
							form: null,
							error: null
						});
					});
				}
			</script>
		</div>
</body>
</html>
